name: Release

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  preflight:
    if: >
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    outputs:
      release_sha: ${{ steps.resolve-sha.outputs.release_sha }}
      should_release: ${{ steps.detect-release.outputs.should_release }}
    steps:
      - name: Resolve release commit SHA
        id: resolve-sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "release_sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "release_sha=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve-sha.outputs.release_sha }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate required secrets
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${VSCE_TOKEN:-}" ]; then
            echo "::error::Missing required secret: VSCE_TOKEN"
            exit 1
          fi

          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "::notice::NPM_TOKEN not set (optional because npm publish is disabled)."
          fi

      - name: Verify VS Marketplace PAT
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
        run: npx vsce verify-pat -p "$VSCE_TOKEN"

      - name: Detect if a semantic release is needed
        id: detect-release
        run: |
          set -euo pipefail
          LAST_TAG="$(git describe --tags --abbrev=0 --match 'v*' 2>/dev/null || true)"
          RANGE="HEAD"
          if [ -n "$LAST_TAG" ]; then
            RANGE="${LAST_TAG}..HEAD"
          fi

          SHOULD_RELEASE="false"
          for SHA in $(git rev-list --no-merges "$RANGE"); do
            SUBJECT="$(git log -n 1 --format=%s "$SHA")"
            BODY="$(git log -n 1 --format=%b "$SHA")"

            if echo "$SUBJECT" | grep -Eq '^(feat|fix|perf)(\([^)]+\))?:'; then
              SHOULD_RELEASE="true"
              break
            fi

            if echo "$SUBJECT" | grep -Eq '^[a-zA-Z0-9_-]+(\([^)]+\))?!:'; then
              SHOULD_RELEASE="true"
              break
            fi

            if echo "$SUBJECT" | grep -Eq '^revert:'; then
              SHOULD_RELEASE="true"
              break
            fi

            if echo "$SUBJECT" | grep -Eq '^Revert "' && echo "$BODY" | grep -q 'This reverts commit '; then
              SHOULD_RELEASE="true"
              break
            fi

            if echo "$BODY" | grep -q 'BREAKING CHANGE'; then
              SHOULD_RELEASE="true"
              break
            fi
          done

          echo "should_release=${SHOULD_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "Release needed: ${SHOULD_RELEASE}"

  release:
    needs: preflight
    if: needs.preflight.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    environment:
      name: marketplace-prod
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.preflight.outputs.release_sha }}
          fetch-depth: 0
          persist-credentials: false
          ssh-key: ${{ secrets.RELEASE_DEPLOY_KEY }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GIT_AUTHOR_NAME: "@semantic-release-bot"
          GIT_AUTHOR_EMAIL: "semantic-release-bot@martynus.net"
          GIT_COMMITTER_NAME: "@semantic-release-bot"
          GIT_COMMITTER_EMAIL: "semantic-release-bot@martynus.net"
        run: npx semantic-release
